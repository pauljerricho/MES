<!DOCTYPE html>
<html lang="en">
<head>
<title>입고 처리</title>
<?include "$_SERVER[DOCUMENT_ROOT]/inc/head_html_text.html";?>
<meta charset="UTF-8">
<link rel="stylesheet" href="/css/inventory.css">
<style>
.wh_wrap{
	width:120px;
}
#table td input[type=text]{
	width:70%;
	margin:0 auto !important;
}
.btn_pm {
	float: left;
	display: inline-block;
    width: 30px;
    height: 30px;
    background: #f2f2f2;
    text-align: center;
    line-height: 30px;
    cursor: pointer;
    margin: 0 0 0 5px;
}
.enable {
	background: #ff8400 !important;
	color: #fff !important;
}
.wh_wrap {
    margin: 8px 5px;
}
.finish_cancel{
	display:none;
}
label.error{
    display:none;
}
@media screen and (max-width: 728px){
	.wh_wrap {
		display:flex;
		align-items:center;
		margin:0;
		width:auto;
	}
	#table td .wh_wrap input {
		margin:0;
		width: 80px !important;
	}
	#table th, #table td {
		padding:0 !important;
	}
}
</style>
<script>
$(document).ready(function() {
	/*URL 파라미터 가져오기*/
	const urlParams = new URLSearchParams(location.search);
	var s_no = urlParams.get("s_no");
	var re_no = urlParams.get("req_no");
	var year = urlParams.get("year");
	
	/*FORM 태그 삽입하기*/
	script_new_reformdata(".sub_con","myform","","");
	$('#myform').append($('<input/>',{type:'hidden',name:'s_no',value:s_no}));
	$('#myform').append($('<input/>',{type:'hidden',name:'re_no',value:re_no}));
	$('#myform').append($('<input/>',{type:'hidden',name:'year',value:year}));
	$('#myform').append($('<input/>',{type:'hidden',name:'tip_index',id:'tip_index',value:''}));
	$('#myform').append($('<input/>',{type:'hidden',name:'tip_index2',id:'tip_index2',value:''}));




	
	//입력제한
	$("#table").on('keyup', "input.req_amount, input.quantity", function(event) {
		var role = $(this).closest("tr").attr("role");
		var mode = $(this).attr("class").split(" ");
		var tip_index1=0, tip_index2=0;
		if(role){
			tip_index1 = $(this).closest("tr").index();
	        tip_index2 = $("#table tbody tr:eq("+tip_index1+") ."+mode[0]).index(this);
		}else{
			tip_index1 = $(this).closest("li").attr("data-dt-row");
	        tip_index2 = $("#table tbody tr.child ul[data-dtr-index='"+tip_index1+"'] ."+mode[0]).index(this);
		}
		if (!(event.keyCode >=37 && event.keyCode<=40)) {
		    var inputVal = $(this).val();
		    $(this).val(Number(inputVal.replace(/[^0-9]/gi,'')));
		    !role ? $("#table tbody tr[role='row']:eq("+tip_index1+") ."+mode[0]).eq(tip_index2).val(Number(inputVal.replace(/[^0-9]/gi,''))) : false;
	    }
	});
	
	//수기 버튼
	$("#myform .btn_pmn").click(function(){
		var id = $(this).attr("id");
		if(id=="nor"){
			$("#table tbody tr[role='row'] input.no_out").each(function(i,v){
				$("#table tbody tr[role='row'] input.quantity").eq(i).val($(this).val());
				//반응형
			    if($("#table tbody tr.child ul[data-dtr-index='"+i+"']").length){
			    	$("#table tbody tr.child ul[data-dtr-index='"+i+"']").find('.quantity').val($(this).val());
			    }
			});
		}else{
			$("#table tbody tr[role='row'] input.quantity").each(function(i,v){
				$("#table tbody tr[role='row'] input.quantity").eq(i).val(0);
			});
		}
	});
	
	//창고명 모달창
	javascript_onload_src("script_ajax_layer_pop");
	$("#myform").on("click", ".wh_name, .zone_name", function(){
		script_ajax_layer_pop('/popup/popup_position.html',jQuery('#myform').serialize()+"&mode=request_reg_in&inout=1",'.popup-5');
	});
	
	//창고 +버튼
	$("#myform").on("click", ".btn_pl", function(){
		var role = $(this).closest("tr").attr("role"); //반응형 구분
		var index = "";
		role ? index = $("#myform .btn_pl").index(this) : index = $(this).closest("li").attr("data-dt-row");
		$("#table tbody tr[role='row']").eq(index).find("td").eq(2).append("<div class='wh_wrap'><span class='btn_minus btn_pm'>-</span><input type='text' class='wh_name' name='wh_name["+index+"][]' style='cursor:pointer;' readonly></div>");
		$("#table tbody tr[role='row']").eq(index).find("td").eq(3).append("<div class='wh_wrap'><input type='text' class='zone_name' name='zone_name["+index+"][]' style='cursor:pointer;' readonly><input type='hidden' class='wh_no' name='wh_no["+index+"][]'></div>");
		$("#table tbody tr[role='row']").eq(index).find("td").eq(4).append("<div class='wh_wrap'><input type='text' class='quantity' name='quantity["+index+"][]' value='0'></div>");
		$("#table tbody tr[role='row']").eq(index).find("td").eq(8).append("<div class='wh_wrap'><input type='text' class='req_amount' name='req_amount["+index+"][]' value='0'><input type='hidden' class='no_out' value='0'></div>");
		$("#table tbody tr[role='row']").eq(index).find("td").eq(9).append("<div class='wh_wrap'><input type='hidden' class='do_amt' name='do_amt["+index+"][]' value='0'>0</div>");
		
		//반응형
	    if($("#table tbody tr.child ul[data-dtr-index='"+index+"']").length){
	    	$("#table tbody tr.child ul[data-dtr-index='"+index+"'] li[data-dt-column='2'] span.dtr-data").append("<div class='wh_wrap'><span class='btn_minus btn_pm'>-</span><input type='text' class='wh_name' name='wh_name["+index+"][]' style='cursor:pointer;' readonly></div>");
	    	$("#table tbody tr.child ul[data-dtr-index='"+index+"'] li[data-dt-column='3'] span.dtr-data").append("<div class='wh_wrap'><input type='text' class='zone_name' name='zone_name["+index+"][]' style='cursor:pointer;' readonly><input type='hidden' class='wh_no' name='wh_no["+index+"][]'></div>");
	    	$("#table tbody tr.child ul[data-dtr-index='"+index+"'] li[data-dt-column='4'] span.dtr-data").append("<div class='wh_wrap'><input type='text' class='quantity' name='quantity["+index+"][]' value='0'></div>");
	    	$("#table tbody tr.child ul[data-dtr-index='"+index+"'] li[data-dt-column='8'] span.dtr-data").append("<div class='wh_wrap'><input type='text' class='req_amount' name='req_amount["+index+"][]' value='0'><input type='hidden' class='no_out' value='0'></div>");
	    	$("#table tbody tr.child ul[data-dtr-index='"+index+"'] li[data-dt-column='9'] span.dtr-data").append("<div class='wh_wrap'><input type='hidden' class='do_amt' name='do_amt["+index+"][]' value='0'>0</div>");
	    }
	});
	
	//창고 -버튼
	$("#myform").on("click", ".btn_minus", function(){
		var role = $(this).closest("tr").attr("role"); //반응형 구분
		var index1=0, index2=0;
		if(role){
			index1 = $(this).closest("tr").index();
	        index2 = $("#table tbody tr:eq("+index1+") .btn_pm").index(this);
		}else{
			index1 = $(this).closest("li").attr("data-dt-row");
	        index2 = $("#table tbody tr.child ul[data-dtr-index='"+index1+"'] .btn_pm").index(this);
		}
        
        $('#table tbody tr[role="row"]').eq(index1).find('td').eq(2).find('div.wh_wrap').eq(index2).remove();
        $('#table tbody tr[role="row"]').eq(index1).find('td').eq(3).find('div.wh_wrap').eq(index2).remove();
        $('#table tbody tr[role="row"]').eq(index1).find('td').eq(4).find('div.wh_wrap').eq(index2).remove();
        $('#table tbody tr[role="row"]').eq(index1).find('td').eq(8).find('div.wh_wrap').eq(index2).remove();
        $('#table tbody tr[role="row"]').eq(index1).find('td').eq(9).find('div.wh_wrap').eq(index2).remove();
        
        //반응형
	    if($("#table tbody tr.child ul[data-dtr-index='"+index1+"']").length){
	    	$("#table tbody tr.child ul[data-dtr-index='"+index1+"'] li[data-dt-column='2'] span.dtr-data").find('div').eq(index2).remove();
	    	$("#table tbody tr.child ul[data-dtr-index='"+index1+"'] li[data-dt-column='3'] span.dtr-data").find('div').eq(index2).remove();
	    	$("#table tbody tr.child ul[data-dtr-index='"+index1+"'] li[data-dt-column='4'] span.dtr-data").find('div').eq(index2).remove();
	    	$("#table tbody tr.child ul[data-dtr-index='"+index1+"'] li[data-dt-column='8'] span.dtr-data").find('div').eq(index2).remove();
	    	$("#table tbody tr.child ul[data-dtr-index='"+index1+"'] li[data-dt-column='9'] span.dtr-data").find('div').eq(index2).remove();
	    }
	});
	
	//입고취소
	$("#myform").on("click", ".cancel", function() {
		script_ajax_layer_pop('/inventory/cancel_search_in.html',"req_no=",'.popup-22');
	});
	
	//바코드 
	$("#myform").on("click", "#table .btn_barcode", function() {
		script_ajax_layer_pop('/popup/popup_box_confirm.html',"s_no=&e_date=&count=",'.popup-b');
	});
	
	//데이터테이블
	$("#table thead tr").prepend("<th>상세</th>");
	$("#table tbody tr").prepend("<td>상세</td>");
	var table = $("#table").DataTable({
		lengthChange : false, // 표시 건수기능 숨기기
		searching : false, // 검색 기능 숨기기
		ordering : false, // 정렬 기능 숨기기
		info : false, // 정보 표시 숨기기
		inventorying : false, // 페이징 기능 숨기기
		serverMethod : 'post',
		order : [ 1, "desc" ],
		dataType : "json",
		paging : false,
		pageLength : 10,
		pagingType : "full_numbers",
		dom : 'rt<"bottom"iflp>',
		language : {
	        "emptyTable": "데이터가 없습니다.",
	        "lengthMenu": "페이지당 _MENU_ 개씩 보기",
	        "info": "현재 _START_ - _END_ / _TOTAL_건",
	        "infoEmpty": "데이터 없음",
	        "infoFiltered": "( _MAX_건의 데이터에서 필터링되었습니다. )",
	        "search": "",
	        "zeroRecords": "일치하는 데이터가 없습니다.",
	        "loadingRecords": "로딩중...",
	        "inventorying":  false,
	        "paginate": {
	            "next": "다음",
	            "previous": "이전",
	            "first": '처음',
	            "last": '끝'
	        }
		},
		responsive: {
            details: {
                type: 'column'
            }
        },
        columnDefs: [ {
            className: 'control',
            orderable: false,
            targets:   0
        }]
	});
	
	new $.fn.dataTable.Responsive( table );
});

function draw_row(table,data,index){
	var wh_name="",zone_name="",req_amt="",btn_pm="",quantity="",do_amt="",doAmtSum=0;
	$.each(data.wh_arr,function(i,v){
		i==0 ? btn_pm = "<span class='btn_pl btn_pm'>+</span>" : btn_pm = "<span class='btn_pm'></span>"; 
		wh_name += "<div class='wh_wrap'>"+btn_pm+"<input type='hidden' class='r_no' name='r_no["+index+"][]' value='"+v.r_no+"'><input type='text' class='wh_name' name='wh_name["+index+"][]' value='"+v.wh_name+"' style='cursor:pointer;' readonly></div>";
		zone_name += "<div class='wh_wrap'><input type='text' class='zone_name' name='zone_name["+index+"][]' value='"+v.zone_name+"' style='cursor:pointer;' readonly><input type='hidden' class='wh_no' name='wh_no["+index+"][]' value='"+v.wh_no+"'></div>";
		req_amt += "<div class='wh_wrap'><input type='text' class='req_amount' name='req_amount["+index+"][]' value='"+v.quantity+"'><input type='hidden' class='no_out' value='"+v.no_out+"'></div>";
		quantity += "<div class='wh_wrap'><input type='text' class='quantity' name='quantity["+index+"][]' value='0' readonly></div>";
		do_amt += "<div class='wh_wrap'><input type='hidden' class='do_amt' name='do_amt["+index+"][]' value='"+v.do_amt+"'>"+v.do_amt+"</div>";
		doAmtSum += Number(v.do_amt);
	});
	doAmtSum>0 ? doAmtSum = "<div class='wh_wrap'>"+doAmtSum+"</div><img class='cancel' alt='취소' src='/img/cancel.png'>" : false;
	table.row.add([
         "<td class='control' tabindex='0'>상세</td>",
         "<div class='btn_barcode'></div>",
         wh_name,
         zone_name,
         quantity,
         "<input type='hidden' class='req_no' name='req_no[]' value='"+data['req_no']+"'>"+data['article_num'],
         data['mt_number']+"<input type='hidden' class='mt_number' name='mt_number[]' value='"+data['mt_number']+"'><input type='hidden' class='box_quantity' name='box_quantity[]' value='"+data['box_quantity']+"'>",
         data['p_name']+"<input type='hidden' name='p_name[]' value='"+data['p_name']+"'>",
         req_amt,
         do_amt,
         "<span class='total_txt'>"+data['quantity']+"</span><input type='hidden' class='total' name='total[]' value='"+data['quantity']+"'>",
         doAmtSum,
         data['remain_amt']+"<input type='hidden' class='remain' name='remain[]' value='"+data['remain_amt']+"'>",
         data['over_amt']+"<input type='hidden' class='over' name='over[]' value='"+data['over_amt']+"'>"
    ]).draw(false);
}
function change_insert(state){
    if(state=='plus'){
        $('#plus').addClass("enable");
        $('#minus').removeClass("enable");
        $('#nor').removeClass("enable");
        $("#myform input.quantity").prop("readonly",true);
    }else if(state=='minus'){
        $('#plus').removeClass("enable");
        $('#minus').addClass("enable");
        $('#nor').removeClass("enable");
        $("#myform input.quantity").prop("readonly",true);
    }else{
        $('#plus').removeClass("enable");
        $('#minus').removeClass("enable");
        $('#nor').addClass("enable");
        $("#myform input.quantity").prop("readonly",false);
    }
}
</script>
</head>
<body>
<div class="background"></div>
<div class="header_wrap">
	<!--header-->
	<?include "$_SERVER[DOCUMENT_ROOT]/inc/header.html";?>
	<!--header-->
</div>
<!--header_wrap-->
<!-- 퀵바 -->
<div class="quick_wrap ui-draggable ui-draggable-handle">
<?include "$_SERVER[DOCUMENT_ROOT]/inc/q_menu.html";?>
</div>
<!-- quick_wrap -->
<?include "$_SERVER[DOCUMENT_ROOT]/inc/m_menu.html";?>
<!--m_menu-->
<div class="content">
	<?include "$_SERVER[DOCUMENT_ROOT]/inc/left_menu.html";?>
	<div class="content_detail" id="content_detail">
		<div id="content" class="requestRegInCont">
			<ul class="lnb">
				<li><a href="/index.html"><img src="/img/icon_home.jpg" alt="홈으로"></a></li>
				<li></li>
				<li><a href="/inventory/main.html">재고관리</a></li>
				<li></li>
				<li><a href="/inventory/request.html">입/출고 요청</a></li>
			</ul>
			<!--lnb-->
			<div class="sub_con">
				<div class="tit_box">
					<h2 class="sub_tit">입고 처리</h2>
				</div>
				<!-- tit_box -->
				<table id="table_reg">
					<tr>
						<th>요청일자</th>
						<td id="reg_date"></td>
					</tr>
					<tr>
						<th>요청정보</th>
						<td id="req_info"></td>
					</tr>
				</table>
				<div class="btn06 btn_pmn" id="nor" onclick="change_insert('nor')">수기</div>
				<div class="btn06 btn_pmn" id="minus" onclick="change_insert('minus')">-</div>
				<div class="btn06 btn_pmn enable" id="plus" onclick="change_insert('plus')">+</div>
				<table id="table" class="table_ri" style="width: 100%">
					<colgroup>
						<col width="6%">
						<col width="9%">
						<col width="9%">
						<col width="9%">
						<col width="3%">
						<col width="8%">
						<col width="8%">
						<col width="8%">
						<col width="8%">
						<col width="8%">
						<col width="8%">
						<col width="8%">
						<col width="8%">
					</colgroup>
					<thead>
						<tr>
							<th>바코드</th>
							<th>창고명</th>
							<th>구역명</th>
							<th>처리량</th>
							<th>번호</th>
							<th>제품번호</th>
							<th>제품명</th>
							<th>요청수량</th>
							<th>입고수량</th>
							<th>총 요청수량</th>
							<th>총 입고수량</th>
							<th>미완료수량</th>
							<th>초과수량</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
						</tr>
					</tbody>
				</table>
				<div class="bot_box">
					<div class="bot_btn">
						<div class="btn"><a href="/inventory/request.html">목록</a></div>
						<div class="btn btn_right finish_cancel" title="입고완료취소">입고완료취소</div>
						<div class="btn btn_right finish" title="입고완료">입고완료</div>
						<div class="btn btn_right apply" title="입고">입고</div>
					</div>
					<!-- bot_btn -->
					<label class="error"></label>
				</div>
				<!-- bot_box -->
			</div>
			<!--con-->
			<div id="lay" style="overflow: auto;">
				<div class="bg"></div>
				<div id="lay2"></div>
			</div>
		</div>
		<!--content-->
	</div>
</div>
<!--content-->
<div id="copy">
	<?include "$_SERVER[DOCUMENT_ROOT]/inc/copy_wrap.html";?>
</div>
<div class="keyboard"></div>
</body>
</html>